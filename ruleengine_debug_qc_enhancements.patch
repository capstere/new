--- /mnt/data/ipt_orig/IPT/Modules/Config.ps1	2026-01-15 08:04:29.000000000 +0000
+++ /mnt/data/ipt_qc/IPT/Modules/Config.ps1	2026-01-19 20:58:32.452144966 +0000
@@ -64,6 +64,7 @@
     EnableRuleEngine    = $true       # New RuleEngine (shadow-mode)
     EnableShadowCompare = $true        # Log diff between legacy and rules when EnableRuleEngine is on
     EnableRuleEngineDebugSheet = $true        # Add RuleEngine_Debug worksheet to output (safe, appended)
+    RuleEngineDebugIncludeAllRows = $false # When true: write ALL rows in RuleEngine_Debug (legacy behavior)
     RuleBankDir         = (Join-Path $ScriptRoot 'RuleBank')
     CsvStreamingThresholdMB = 25   # Byt till t.ex. 10 om du vill streama tidigare
     CsvPath       = ''           # SÃ¶kvÃ¤g till CSV-fil
--- /mnt/data/ipt_orig/IPT/Main.ps1	2026-01-18 09:27:01.000000000 +0000
+++ /mnt/data/ipt_qc/IPT/Main.ps1	2026-01-19 20:59:08.498258591 +0000
@@ -3166,7 +3166,8 @@
 
                     if ($script:RuleEngineShadow -and $script:RuleEngineShadow.Rows -and $script:RuleEngineShadow.Rows.Count -gt 0) {
                         Gui-Log "ðŸ§  Skriver RuleEngine_Debug (shadow)..." 'Info'
-                        [void](Write-RuleEngineDebugSheet -Pkg $pkgOut -RuleEngineResult $script:RuleEngineShadow)
+                        $includeAll = (Test-ConfigFlag $Config 'RuleEngineDebugIncludeAllRows' $false)
+                        [void](Write-RuleEngineDebugSheet -Pkg $pkgOut -RuleEngineResult $script:RuleEngineShadow -IncludeAllRows $includeAll)
                     } else {
                         Gui-Log "âš ï¸ RuleEngine_Debug hoppar Ã¶ver: inget RuleEngine-resultat." 'Warn'
                     }
--- /mnt/data/ipt_orig/IPT/Modules/RuleEngine.ps1	2026-01-15 12:12:01.000000000 +0000
+++ /mnt/data/ipt_qc/IPT/Modules/RuleEngine.ps1	2026-01-19 21:01:56.777462033 +0000
@@ -906,6 +906,9 @@
                     ExpectedWhy      = $expD.Reason
                     ExpectedSource   = $expSrc
                     Deviation        = $dev
+                    ModuleSN         = (Get-RowField -Row $row -FieldName 'Module S/N')
+                    StartTime        = (Get-RowField -Row $row -FieldName 'Start Time')
+                    RuleFlags        = ''
                 })
 
             } catch {
@@ -916,6 +919,77 @@
         }
     }
 
+
+
+    # --- QC post-processing (file-level validations + per-row flags) ---
+    function _Append-RuleFlag {
+        param([pscustomobject]$row, [string]$flag)
+        $f = (($row.RuleFlags + '')).Trim()
+        if (-not $f) { $row.RuleFlags = $flag; return }
+        $parts = $f.Split('|')
+        if ($parts -contains $flag) { return }
+        $row.RuleFlags = ($f + '|' + $flag)
+    }
+
+    # Distinct counts (file-level)
+    $distinctAssays = @($results | ForEach-Object { ($_.Assay + '').Trim() } | Where-Object { $_ } | Sort-Object -Unique)
+    $distinctAssayVersions = @($results | ForEach-Object { ($_.AssayVersion + '').Trim() } | Where-Object { $_ } | Sort-Object -Unique)
+    $distinctReagentLots = @($results | ForEach-Object { ($_.ReagentLotId + '').Trim() } | Where-Object { $_ } | Sort-Object -Unique)
+
+    # Duplicate Sample IDs
+    $dupSample = @($results | Where-Object { (($_.SampleId + '').Trim()) } | Group-Object SampleId | Where-Object { $_.Count -gt 1 })
+    if ($dupSample.Count -gt 0) {
+        $dupSet = @{}
+        foreach ($g in $dupSample) { $dupSet[$g.Name] = $true }
+        foreach ($r in $results) {
+            $sid = ((($r.SampleId + '')).Trim())
+            if ($sid -and $dupSet.ContainsKey($sid)) { _Append-RuleFlag -row $r -flag 'DQ_DUP_SAMPLEID' }
+        }
+    }
+
+    # Duplicate Cartridge S/N
+    $dupCart = @($results | Where-Object { (($_.CartridgeSN + '').Trim()) } | Group-Object CartridgeSN | Where-Object { $_.Count -gt 1 })
+    if ($dupCart.Count -gt 0) {
+        $dupSet = @{}
+        foreach ($g in $dupCart) { $dupSet[$g.Name] = $true }
+        foreach ($r in $results) {
+            $csn = ((($r.CartridgeSN + '')).Trim())
+            if ($csn -and $dupSet.ContainsKey($csn)) { _Append-RuleFlag -row $r -flag 'DQ_DUP_CARTSN' }
+        }
+    }
+
+    # Test Type mismatch (derived expected vs actual)
+    foreach ($r in $results) {
+        $act = ((($r.TestType + '')).Trim())
+        $exp = ((($r.ExpectedTestType + '')).Trim())
+        if ($act -and $exp -and ($act.ToUpperInvariant() -ne $exp.ToUpperInvariant())) {
+            _Append-RuleFlag -row $r -flag 'TESTTYPE_MISMATCH'
+        }
+    }
+
+    # Module hotspot: >=3 ERROR rows on same Module S/N
+    $hotModules = @{}
+    $byModErr = @($results | Where-Object { (($_.ModuleSN + '').Trim()) -and (($_.ObservedCall + '').Trim().ToUpperInvariant() -eq 'ERROR') } | Group-Object ModuleSN)
+    foreach ($g in $byModErr) {
+        if ($g.Count -ge 3) { $hotModules[$g.Name] = $g.Count }
+    }
+    if ($hotModules.Count -gt 0) {
+        foreach ($r in $results) {
+            $m = ((($r.ModuleSN + '')).Trim())
+            if ($m -and $hotModules.ContainsKey($m)) { _Append-RuleFlag -row $r -flag 'MODULE_ERR_HOTSPOT' }
+        }
+    }
+
+    # Attach QC stats to result (used by Debug sheet summary)
+    $qc = [pscustomobject]@{
+        DistinctAssays = $distinctAssays
+        DistinctAssayVersions = $distinctAssayVersions
+        DistinctReagentLots = $distinctReagentLots
+        DuplicateSampleIdCount = ($dupSample | ForEach-Object { $_.Name } | Select-Object -Unique).Count
+        DuplicateCartridgeSnCount = ($dupCart | ForEach-Object { $_.Name } | Select-Object -Unique).Count
+        HotModuleCount = $hotModules.Count
+    }
+    # ---------------------------------------------------------------
     $summary = [pscustomobject]@{
         Total = $results.Count
         ObservedCounts = @{}
@@ -936,13 +1010,14 @@
 
     $top = @($results | Where-Object { $_.Deviation -in @('FP','FN','ERROR','MISMATCH') } | Select-Object -First 50)
 
-    return [pscustomobject]@{ Rows = $results.ToArray(); Summary = $summary; TopDeviations = $top }
+    return [pscustomobject]@{ Rows = $results.ToArray(); Summary = $summary; TopDeviations = $top; QC = $qc }
 }
 
 function Write-RuleEngineDebugSheet {
     param(
         [Parameter(Mandatory)][object]$Pkg,
-        [Parameter(Mandatory)][pscustomobject]$RuleEngineResult
+        [Parameter(Mandatory)][pscustomobject]$RuleEngineResult,
+        [Parameter(Mandatory=$false)][bool]$IncludeAllRows = $false
     )
 
     try {
@@ -953,57 +1028,143 @@
     $ws = $Pkg.Workbook.Worksheets.Add('RuleEngine_Debug')
 
     $headers = @(
-        '#','Sample ID','Cartridge S/N','Test Type','Expected Test Type','ControlCode',
+        '#','Sample ID','Cartridge S/N','Module S/N','Start Time',
+        'Test Type','Expected Test Type','ControlCode',
         'SampleToken','BaseToken','ActualSuffix','ExpectedSuffix','SuffixCheck','SuffixSource',
         'SampleNum','SampleNumOK','SampleNumWhy',
-        'Expected Call','ExpectedSource','Observed Call','ObservedWhy','Deviation',
+        'Expected Call','ExpectedSource','Observed Call','ObservedWhy','Deviation','RuleFlags',
         'Status','ErrorCode','ErrorName','Retest','Max Pressure','PressureFlag',
         'Test Result','Error'
     )
 
+    # --- Summary section (always written, even when exception-only table has 0 rows) ---
+    $row = 1
+    $ws.Cells[$row,1].Value = 'RuleEngine Debug Summary'
+    $ws.Cells[$row,1].Style.Font.Bold = $true
+    $row++
+
+    $sum = $RuleEngineResult.Summary
+    $qc  = $RuleEngineResult.QC
+
+    function _WriteKV {
+        param([int]$r, [string]$k, $v)
+        $ws.Cells[$r,1].Value = $k
+        $ws.Cells[$r,2].Value = $v
+        $ws.Cells[$r,1].Style.Font.Bold = $true
+    }
+
+    _WriteKV -r $row -k 'Total tests' -v $sum.Total; $row++
+
+    foreach ($k in @('OK','FP','FN','ERROR','MISMATCH','UNKNOWN')) {
+        if ($sum.DeviationCounts.ContainsKey($k)) { _WriteKV -r $row -k ('Deviation ' + $k) -v $sum.DeviationCounts[$k]; $row++ }
+    }
+
+    foreach ($k in @('POS','NEG','ERROR','UNKNOWN')) {
+        if ($sum.ObservedCounts.ContainsKey($k)) { _WriteKV -r $row -k ('Observed ' + $k) -v $sum.ObservedCounts[$k]; $row++ }
+    }
+
+    _WriteKV -r $row -k 'Retest YES' -v $sum.RetestYes; $row++
+
+    if ($qc) {
+        _WriteKV -r $row -k 'Assays (distinct)' -v ($qc.DistinctAssays.Count); $row++
+        _WriteKV -r $row -k 'Assay versions (distinct)' -v ($qc.DistinctAssayVersions.Count); $row++
+        _WriteKV -r $row -k 'Reagent lots (distinct)' -v ($qc.DistinctReagentLots.Count); $row++
+        _WriteKV -r $row -k 'Duplicate Sample IDs' -v $qc.DuplicateSampleIdCount; $row++
+        _WriteKV -r $row -k 'Duplicate Cartridge S/N' -v $qc.DuplicateCartridgeSnCount; $row++
+        _WriteKV -r $row -k 'Hot modules (>=3 errors)' -v $qc.HotModuleCount; $row++
+
+        if ($qc.DistinctAssays.Count -gt 1) { _WriteKV -r $row -k 'Assay list' -v ($qc.DistinctAssays -join ', '); $row++ }
+        if ($qc.DistinctAssayVersions.Count -gt 1) { _WriteKV -r $row -k 'Assay version list' -v ($qc.DistinctAssayVersions -join ', '); $row++ }
+        if ($qc.DistinctReagentLots.Count -gt 1) { _WriteKV -r $row -k 'Reagent lot list' -v ($qc.DistinctReagentLots -join ', '); $row++ }
+    }
+
+    $row++
+    $tableHeaderRow = $row
+
     for ($c = 1; $c -le $headers.Count; $c++) {
-        $ws.Cells[1,$c].Value = $headers[$c-1]
-        $ws.Cells[1,$c].Style.Font.Bold = $true
+        $ws.Cells[$tableHeaderRow,$c].Value = $headers[$c-1]
+        $ws.Cells[$tableHeaderRow,$c].Style.Font.Bold = $true
     }
 
     $rows = $RuleEngineResult.Rows
-    $rOut = 2
+
+    # --- Exception-based filter (does NOT modify RuleEngineResult) ---
+    $rowsToWrite = $rows
+    if (-not $IncludeAllRows) {
+        $rowsToWrite = @($rows | Where-Object {
+            $dev = (($_.Deviation + '')).Trim().ToUpperInvariant()
+            $hasDeviation = ($dev.Length -gt 0 -and $dev -ne 'OK')
+
+            $obs = (($_.ObservedCall + '')).Trim().ToUpperInvariant()
+            $observedErr = ($obs -eq 'ERROR')
+
+            $pressureFlag = $false
+            try { $pressureFlag = [bool]$_.PressureFlag } catch { $pressureFlag = $false }
+
+            $hasErrorCode = ((($_.ErrorCode + '')).Trim().Length -gt 0)
+
+            $st = (($_.Status + '')).Trim()
+            $statusNotDone = ($st.Length -gt 0 -and $st -ne 'Done')
+
+            $retestTrue = $false
+            $rt = (($_.GeneratesRetest + '')).Trim().ToUpperInvariant()
+            if ($rt -in @('YES','Y','TRUE','1')) { $retestTrue = $true }
+
+            $rf = (($_.RuleFlags + '')).Trim()
+            $hasRuleFlags = ($rf.Length -gt 0)
+
+            return ($hasDeviation -or $observedErr -or $pressureFlag -or $hasErrorCode -or $statusNotDone -or $retestTrue -or $hasRuleFlags)
+        })
+    }
+
+    if (-not $rowsToWrite -or $rowsToWrite.Count -eq 0) {
+        $ws.Cells[$tableHeaderRow+1,2].Value = 'No deviations found'
+        $ws.Cells[$tableHeaderRow+1,2].Style.Font.Italic = $true
+        try { if ($ws.Dimension) { $ws.Cells[$ws.Dimension.Address].AutoFitColumns() } } catch {}
+        return $ws
+    }
+
+    $rOut = $tableHeaderRow + 1
     $idx = 1
 
-    foreach ($r in $rows) {
+    foreach ($r in $rowsToWrite) {
         $ws.Cells[$rOut,1].Value  = $idx
         $ws.Cells[$rOut,2].Value  = ($r.SampleId + '')
         $ws.Cells[$rOut,3].Value  = ($r.CartridgeSN + '')
-        $ws.Cells[$rOut,4].Value  = ($r.TestType + '')
-        $ws.Cells[$rOut,5].Value  = ($r.ExpectedTestType + '')
-        $ws.Cells[$rOut,6].Value  = ($r.ControlCode + '')
-
-        $ws.Cells[$rOut,7].Value  = ($r.SampleToken + '')
-        $ws.Cells[$rOut,8].Value  = ($r.BaseToken + '')
-        $ws.Cells[$rOut,9].Value  = ($r.ActualSuffix + '')
-        $ws.Cells[$rOut,10].Value = ($r.ExpectedSuffix + '')
-        $ws.Cells[$rOut,11].Value = ($r.SuffixCheck + '')
-        $ws.Cells[$rOut,12].Value = ($r.SuffixSource + '')
-
-        $ws.Cells[$rOut,13].Value = ($r.SampleNum + '')
-        $ws.Cells[$rOut,14].Value = ($r.SampleNumOK + '')
-        $ws.Cells[$rOut,15].Value = ($r.SampleNumWhy + '')
-
-        $ws.Cells[$rOut,16].Value = ($r.ExpectedCall + '')
-        $ws.Cells[$rOut,17].Value = ($r.ExpectedSource + '')
-        $ws.Cells[$rOut,18].Value = ($r.ObservedCall + '')
-        $ws.Cells[$rOut,19].Value = ($r.ObservedWhy + '')
-        $ws.Cells[$rOut,20].Value = ($r.Deviation + '')
-
-        $ws.Cells[$rOut,21].Value = ($r.Status + '')
-        $ws.Cells[$rOut,22].Value = ($r.ErrorCode + '')
-        $ws.Cells[$rOut,23].Value = ($r.ErrorName + '')
-        $ws.Cells[$rOut,24].Value = ($r.GeneratesRetest + '')
-        $ws.Cells[$rOut,25].Value = $(if ($null -ne $r.MaxPressure) { $r.MaxPressure } else { '' })
-        $ws.Cells[$rOut,26].Value = $(if ($r.PressureFlag) { 'YES' } else { '' })
+        $ws.Cells[$rOut,4].Value  = ($r.ModuleSN + '')
+        $ws.Cells[$rOut,5].Value  = ($r.StartTime + '')
+
+        $ws.Cells[$rOut,6].Value  = ($r.TestType + '')
+        $ws.Cells[$rOut,7].Value  = ($r.ExpectedTestType + '')
+        $ws.Cells[$rOut,8].Value  = ($r.ControlCode + '')
+
+        $ws.Cells[$rOut,9].Value  = ($r.SampleToken + '')
+        $ws.Cells[$rOut,10].Value = ($r.BaseToken + '')
+        $ws.Cells[$rOut,11].Value = ($r.ActualSuffix + '')
+        $ws.Cells[$rOut,12].Value = ($r.ExpectedSuffix + '')
+        $ws.Cells[$rOut,13].Value = ($r.SuffixCheck + '')
+        $ws.Cells[$rOut,14].Value = ($r.SuffixSource + '')
+
+        $ws.Cells[$rOut,15].Value = ($r.SampleNum + '')
+        $ws.Cells[$rOut,16].Value = ($r.SampleNumOK + '')
+        $ws.Cells[$rOut,17].Value = ($r.SampleNumWhy + '')
+
+        $ws.Cells[$rOut,18].Value = ($r.ExpectedCall + '')
+        $ws.Cells[$rOut,19].Value = ($r.ExpectedSource + '')
+        $ws.Cells[$rOut,20].Value = ($r.ObservedCall + '')
+        $ws.Cells[$rOut,21].Value = ($r.ObservedWhy + '')
+        $ws.Cells[$rOut,22].Value = ($r.Deviation + '')
+        $ws.Cells[$rOut,23].Value = ($r.RuleFlags + '')
+
+        $ws.Cells[$rOut,24].Value = ($r.Status + '')
+        $ws.Cells[$rOut,25].Value = ($r.ErrorCode + '')
+        $ws.Cells[$rOut,26].Value = ($r.ErrorName + '')
+        $ws.Cells[$rOut,27].Value = ($r.GeneratesRetest + '')
+        $ws.Cells[$rOut,28].Value = $(if ($null -ne $r.MaxPressure) { $r.MaxPressure } else { '' })
+        $ws.Cells[$rOut,29].Value = $(if ($r.PressureFlag) { 'YES' } else { '' })
 
-        $ws.Cells[$rOut,27].Value = ($r.TestResult + '')
-        $ws.Cells[$rOut,28].Value = ($r.ErrorText + '')
+        $ws.Cells[$rOut,30].Value = ($r.TestResult + '')
+        $ws.Cells[$rOut,31].Value = ($r.ErrorText + '')
 
         $rOut++; $idx++
     }
